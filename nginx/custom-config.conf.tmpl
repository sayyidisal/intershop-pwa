server {
    server_name www.exampleshop.com;
    listen 80;

    # let ICM handle everything ICM related
    location ~* ^/INTERSHOP.*$ {
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header X-Cache-Status IGNORE;

        proxy_pass $UPSTREAM_PWA;
    }

    # respect cache entries of static assets
    location ~* ^/(ngx_pagespeed_beacon.*|assets|.*\.(js|css|ico|json|txt|webmanifest|woff|woff2))(.*)$ {
        proxy_cache my_cache;
        proxy_cache_use_stale error timeout http_404 http_500 http_502 http_503 http_504;

        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header X-Cache-Status $upstream_cache_status;

        proxy_pass $UPSTREAM_PWA;
    }

    # cache and rewriting for rendered pages
    location /se-sv {
        proxy_cache my_cache;
        proxy_cache_use_stale error timeout http_404 http_500 http_502 http_503 http_504;

        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header X-Cache-Status $upstream_cache_status;

        proxy_ignore_headers Cache-Control;
        proxy_cache_valid 200 302 10m;
        proxy_cache_valid 404      1m;

        rewrite ^/se-sv$ /se-sv/home;
        rewrite ^(.*)$ "$1;lang=de_DE;channel=inSPIRED-inTRONICS-Site;redirect=1" break;

        proxy_pass $UPSTREAM_PWA;
    }

    location /en-us {
        proxy_cache my_cache;
        proxy_cache_use_stale error timeout http_404 http_500 http_502 http_503 http_504;

        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header X-Cache-Status $upstream_cache_status;

        proxy_ignore_headers Cache-Control;
        proxy_cache_valid 200 302 10m;
        proxy_cache_valid 404      1m;

        rewrite ^/$ /home;
        rewrite ^(.*)$ "$1;lang=en_US;channel=inSPIRED-inTRONICS_Business-Site;redirect=1" break;

        proxy_pass $UPSTREAM_PWA;
    }

    location / {
        if ($request_uri = '/') {
            rewrite ^(.*)$ "$scheme://$http_host/se-sv/home" permanent;
        }
        rewrite ^(.*)$ "$scheme://$http_host/se-sv$request_uri" permanent;
    }

    # redirect server error pages to the static page /50x.html
    #
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
